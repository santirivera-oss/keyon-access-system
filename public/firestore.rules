rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // üîê FUNCIONES AUXILIARES
    // ========================================
    
    // Verificar si el usuario est√° autenticado con Firebase Auth (solo admin)
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar si es admin autenticado
    function isAdmin() {
      return request.auth != null && request.auth.token.email != null;
    }
    
    // Validar que los datos no contengan campos peligrosos
    function noMaliciousFields() {
      return !request.resource.data.keys().hasAny(['__proto__', 'constructor', 'prototype']);
    }
    
    // Validar tama√±o m√°ximo de documento (prevenir abuso)
    function isReasonableSize() {
      return request.resource.size() < 1000000; // 1MB m√°ximo
    }
    
    // ========================================
    // üë®‚Äçüéì COLECCI√ìN: ALUMNOS
    // ========================================
    match /alumnos/{alumnoId} {
      // ‚úÖ Lectura: permitida (necesario para login por QR/barcode)
      allow read: if true;
      
      // ‚úÖ Crear: solo admin autenticado
      allow create: if isAdmin() && noMaliciousFields();
      
      // ‚úÖ Actualizar: 
      // - Admin puede actualizar todo
      // - Sistema puede actualizar campos espec√≠ficos (password, facial, onesignal)
      allow update: if noMaliciousFields() && isReasonableSize() && (
        isAdmin() ||
        // Campos permitidos para auto-actualizaci√≥n (sin auth)
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'password', 'passwordCreatedAt', 'passwordResetAt', 'passwordResetBy',
          'reconocimientoFacial',
          'onesignal_id', 'onesignal_token',
          'whatsapp'
        ])
      );
      
      // ‚ùå Eliminar: solo admin
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üë®‚Äçüè´ COLECCI√ìN: PROFESORES
    // ========================================
    match /profesores/{profesorId} {
      // ‚úÖ Lectura: permitida (necesario para login)
      allow read: if true;
      
      // ‚úÖ Crear: solo admin
      allow create: if isAdmin() && noMaliciousFields();
      
      // ‚úÖ Actualizar: admin o campos espec√≠ficos
      allow update: if noMaliciousFields() && isReasonableSize() && (
        isAdmin() ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'password', 'passwordCreatedAt', 'passwordResetAt', 'passwordResetBy',
          'reconocimientoFacial',
          'onesignal_id', 'onesignal_token',
          'telefono', 'whatsapp',
          'materias', 'grupos', 'horario', 'iniciales'
        ])
      );
      
      // ‚ùå Eliminar: solo admin
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üë§ COLECCI√ìN: USUARIOS (tokens y notificaciones)
    // ========================================
    match /usuarios/{usuarioId} {
      allow read: if true;
      allow create: if noMaliciousFields();
      allow update: if noMaliciousFields() && isReasonableSize();
      allow delete: if isAdmin();
      
      // Subcolecci√≥n de notificaciones personales
      match /notificaciones/{notifId} {
        allow read: if true;
        allow create: if noMaliciousFields();
        allow update: if noMaliciousFields();
        allow delete: if isAdmin();
      }
    }
    
    // ========================================
    // üìö COLECCI√ìN: SESIONES (clases activas)
    // ========================================
    match /sesiones/{sesionId} {
      // ‚úÖ Lectura: permitida (dashboard, reportes)
      allow read: if true;
      
      // ‚úÖ Crear: permitido (profesor inicia clase)
      allow create: if noMaliciousFields() && isReasonableSize();
      
      // ‚úÖ Actualizar: permitido (agregar alumnos, finalizar)
      allow update: if noMaliciousFields() && isReasonableSize();
      
      // ‚ùå Eliminar: solo admin
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üìù COLECCI√ìN: REGISTROS (log de asistencia)
    // ========================================
    match /registros/{registroId} {
      allow read: if true;
      allow create: if noMaliciousFields();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üè´ COLECCI√ìN: INGRESOS_CBTIS (kiosko)
    // ========================================
    match /ingresos_cbtis/{ingresoId} {
      allow read: if true;
      allow create: if noMaliciousFields();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üìã COLECCI√ìN: AVISOS
    // ========================================
    match /avisos/{avisoId} {
      allow read: if true;
      allow create: if noMaliciousFields();
      allow update: if noMaliciousFields();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üí¨ COLECCI√ìN: CHATS
    // ========================================
    match /chats/{chatId} {
      allow read: if true;
      allow create: if noMaliciousFields();
      allow update: if noMaliciousFields();
      allow delete: if isAdmin();
      
      match /mensajes/{mensajeId} {
        allow read: if true;
        allow create: if noMaliciousFields();
        allow update: if noMaliciousFields();
        allow delete: if isAdmin();
      }
    }
    
    // ========================================
    // üìÖ COLECCI√ìN: HORARIOS
    // ========================================
    match /horarios/{horarioId} {
      allow read: if true;
      allow create: if isAdmin() && noMaliciousFields();
      allow update: if isAdmin() && noMaliciousFields();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üìã COLECCI√ìN: ASIGNACIONES
    // ========================================
    match /asignaciones/{asignacionId} {
      allow read: if true;
      allow create: if noMaliciousFields();
      allow update: if noMaliciousFields();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üìä COLECCI√ìN: REPORTES (disciplina)
    // ========================================
    match /reportes/{reporteId} {
      allow read: if true;
      allow create: if noMaliciousFields();
      allow update: if noMaliciousFields();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üìÑ COLECCI√ìN: CITATORIOS
    // ========================================
    match /citatorios/{citatorioId} {
      allow read: if true;
      allow create: if noMaliciousFields();
      allow update: if noMaliciousFields();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üìù COLECCI√ìN: PERMISOS (salidas)
    // ========================================
    match /permisos/{permisoId} {
      allow read: if true;
      allow create: if noMaliciousFields();
      allow update: if noMaliciousFields();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üîî COLECCI√ìN: NOTIFICACIONES
    // ========================================
    match /notificaciones/{notifId} {
      allow read: if true;
      allow create: if noMaliciousFields();
      allow update: if noMaliciousFields();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üì± COLECCI√ìN: NOTIFICACIONES_PUSH
    // ========================================
    match /notificaciones_push/{pushId} {
      allow read: if true;
      allow create: if noMaliciousFields();
      allow update: if noMaliciousFields();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üé≠ COLECCI√ìN: LOGS_FACIAL (inmutable)
    // ========================================
    match /logs_facial/{logId} {
      allow read: if true;
      allow create: if noMaliciousFields();
      allow update: if false; // Logs son inmutables
      allow delete: if isAdmin();
    }
    
    // ========================================
    // üö´ REGLA POR DEFECTO - DENEGAR TODO LO DEM√ÅS
    // ========================================
    // Cualquier colecci√≥n no especificada ser√° denegada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

